---
- name: Install dependencies for Netdata
  ansible.builtin.apt:
    name:
      - curl
      - bash
    state: present
    update_cache: yes

- name: Install Netdata using official install script (2025 URL)
  ansible.builtin.shell: |
    bash <(curl -Ss https://kickstart.netdata.cloud/install.sh) --disable-telemetry --non-interactive
  args:
    executable: /bin/bash
  become: yes
  register: netdata_install
  changed_when: "'already installed' not in netdata_install.stdout"

- name: Reload systemd daemon
  ansible.builtin.command: systemctl daemon-reexec
  ignore_errors: yes

- name: Reload systemd units
  ansible.builtin.command: systemctl daemon-reload
  ignore_errors: yes

# âœ… Try to start Netdata whether it's installed as service or binary
- name: Ensure Netdata service is enabled and running (systemd)
  ansible.builtin.service:
    name: netdata
    state: started
    enabled: true
  ignore_errors: yes

- name: Start Netdata manually if systemd service not found
  ansible.builtin.shell: |
    if ! systemctl status netdata >/dev/null 2>&1; then
      nohup /usr/sbin/netdata >/dev/null 2>&1 &
    fi
  args:
    executable: /bin/bash
  ignore_errors: yes
