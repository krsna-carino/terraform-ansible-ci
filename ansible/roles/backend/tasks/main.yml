---
- name: Install dependencies for Netdata
  ansible.builtin.apt:
    name:
      - curl
      - bash
      - net-tools
    state: present
    update_cache: yes

# ✅ Install Netdata (non-interactive, latest official method)
- name: Install Netdata using official install script
  ansible.builtin.shell: |
    bash <(curl -Ss https://kickstart.netdata.cloud/install.sh) --disable-telemetry --non-interactive
  args:
    executable: /bin/bash
  become: yes
  register: netdata_install
  changed_when: "'already installed' not in netdata_install.stdout"

# ✅ Detect Netdata binary path
- name: Find Netdata binary path
  ansible.builtin.shell: |
    if [ -x /usr/sbin/netdata ]; then
      echo /usr/sbin/netdata
    elif [ -x /opt/netdata/usr/sbin/netdata ]; then
      echo /opt/netdata/usr/sbin/netdata
    else
      which netdata || echo "notfound"
    fi
  args:
    executable: /bin/bash
  register: netdata_bin
  changed_when: false

# ✅ Start Netdata manually if not running
- name: Start Netdata manually using correct binary
  ansible.builtin.shell: |
    BIN="{{ netdata_bin.stdout }}"
    if [ "$BIN" != "notfound" ]; then
      if ! pgrep -x netdata >/dev/null 2>&1; then
        nohup $BIN >/dev/null 2>&1 &
      fi
    fi
  args:
    executable: /bin/bash
  changed_when: true

# ✅ Wait for port 19999 to come online
- name: Wait for Netdata to be available
  ansible.builtin.wait_for:
    host: "{{ ansible_host }}"
    port: 19999
    delay: 10
    timeout: 90
  register: netdata_wait
  retries: 3
  until: netdata_wait is succeeded
