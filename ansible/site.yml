---
- hosts: all
  become: yes
  gather_facts: no

  pre_tasks:
    - name: Ensure Python 3 is installed if missing
      raw: |
        if ! command -v python3 >/dev/null 2>&1; then
          if [ -f /etc/os-release ]; then
            source /etc/os-release
            if [[ "$ID" == "amzn" || "$ID_LIKE" == *"amzn"* ]]; then
              yum install -y python3
            elif [[ "$ID" == "ubuntu" || "$ID_LIKE" == *"debian"* ]]; then
              apt-get update -y && apt-get install -y python3
            fi
          fi
        fi

    - name: Force Python interpreter for Amazon Linux
      set_fact:
        ansible_python_interpreter: /usr/bin/python3
      when: inventory_hostname in groups['frontend']

    - name: Gather facts
      setup:

  roles:
    - common

- hosts: frontend
  become: yes
  roles:
    - frontend

- hosts: backend
  become: yes
  roles:
    - backend
